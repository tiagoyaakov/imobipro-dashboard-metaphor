# üîß Plano de Refinamento - M√ìDULO AGENDA

**Data de Cria√ß√£o:** 03/08/2025  
**Status:** üìã Documento de Planejamento  
**M√≥dulo:** Agenda (Sistema de Agendamentos Inteligente)  
**√öltima Atualiza√ß√£o:** 03/08/2025  

---

## üìã **Vis√£o Geral**

Este documento detalha o plano de a√ß√µes de implementa√ß√£o, corre√ß√£o e desenvolvimento para tornar o **M√≥dulo Agenda** **100% funcional**, com integra√ß√£o completa ao banco de dados, sincroniza√ß√£o Google Calendar e automa√ß√µes N8N.

O m√≥dulo Agenda est√° em situa√ß√£o √∫nica: possui **70% do backend implementado** e **80% da UI completa**, mas apenas **30% de integra√ß√£o real**. O foco ser√° conectar a infraestrutura existente aos dados reais.

---

## üéØ **STATUS ATUAL E PROBLEMAS IDENTIFICADOS**

### **üìä Status Atual (Baseado na Auditoria)**

| Aspecto | Status Atual | Meta |
|---------|-------------|------|
| **Backend/Servi√ßos** | 70% (estrutura criada) | 100% conectado |
| **UI/Componentes** | 80% (interface pronta) | 100% funcional |
| **Integra√ß√£o Real** | 30% (dados mockados) | 100% dados reais |
| **Google Calendar** | 60% (OAuth pronto) | 100% sincronizado |
| **N8N Integration** | 20% (dashboard criado) | 100% configurado |
| **Testes** | 0% | 80% cobertura |

### **üö® Problemas Cr√≠ticos Identificados**

1. **Interface usa dados 100% mockados** - Appointments n√£o v√™m do Supabase
2. **A√ß√µes n√£o funcionais** - Bot√µes apenas fazem console.log()
3. **Tabs importantes ocultas** - AgentAvailability e configura√ß√µes inacess√≠veis
4. **Console.logs em produ√ß√£o** - 15+ ocorr√™ncias de debug logs
5. **Sincroniza√ß√£o parcial** - Google Calendar conecta mas n√£o sincroniza eventos
6. **N8N dashboard sem backend** - Interface existe mas n√£o funciona
7. **Conflitos n√£o tratados** - UI preparada mas l√≥gica ausente

### **‚úÖ Pontos Fortes Identificados**
- Arquitetura bem estruturada e modular
- Sistema de slots e disponibilidade robusto
- Schema do banco bem projetado
- Hooks e servi√ßos bem organizados
- Integra√ß√£o Google Calendar 60% implementada

---

## üóìÔ∏è **CRONOGRAMA DE REFINAMENTO - 6-10 DIAS**

| Etapa | Descri√ß√£o | Dura√ß√£o | Prioridade |
|-------|-----------|---------|------------|
| **1** | Conectar Dados Reais | 2-3 dias | üî¥ CR√çTICA |
| **2** | Funcionalidades Principais | 2-3 dias | üü° ALTA |
| **3** | Integra√ß√µes Avan√ßadas | 1-2 dias | üü† M√âDIA |
| **4** | Testes e Valida√ß√£o | 1-2 dias | üü¢ IMPORTANTE |

---

## üîß **ETAPA 1: CONECTAR DADOS REAIS**
**Dura√ß√£o:** 2-3 dias | **Prioridade:** üî¥ CR√çTICA

### **üéØ Contexto**
A interface est√° 80% pronta mas usa dados mockados. Os servi√ßos existem (70% implementados) mas n√£o est√£o conectados √† UI. Precisa substituir dados mockados por calls reais ao Supabase.

### **üìã Objetivos Espec√≠ficos**
- [ ] Conectar appointments mockados ao Supabase real
- [ ] Implementar CRUD real usando hooks existentes
- [ ] Ativar sistema de slots de disponibilidade
- [ ] Implementar valida√ß√£o de conflitos de hor√°rio
- [ ] Remover userId mockado e usar auth real

### **üóÇÔ∏è Tarefas Detalhadas**

#### **Task 1.1: Conectar Appointments ao Supabase**
```typescript
// src/pages/Agenda.tsx - Remover dados mockados
const mockAppointments = [...] // REMOVER ESTA LINHA

// Usar hook real:
const { appointments, isLoading, error } = useAppointments(user?.id);
```

#### **Task 1.2: Implementar CRUD Real de Appointments**
```typescript
// Conectar a√ß√µes aos servi√ßos existentes:
- createAppointment() ‚Üí agendaService.createAppointment()
- updateAppointment() ‚Üí agendaService.updateAppointment() 
- deleteAppointment() ‚Üí agendaService.deleteAppointment()
- Remover todos os console.log() e implementar a√ß√µes reais
```

#### **Task 1.3: Ativar Sistema de Slots**
```typescript
// src/hooks/useAgenda.ts
- Conectar useAvailabilitySlots() aos dados reais
- Implementar gera√ß√£o autom√°tica de slots
- Validar disponibilidade em tempo real
- Sistema de reserva de slots
```

#### **Task 1.4: Valida√ß√£o de Conflitos**
```typescript
// Implementar l√≥gica de detec√ß√£o de conflitos:
- Sobreposi√ß√£o de hor√°rios
- Duplo agendamento
- Limites de agendamentos por dia
- Valida√ß√£o de hor√°rio de trabalho
```

### **üìÅ Arquivos a Criar/Modificar**
- `src/pages/Agenda.tsx` - Conectar aos dados reais (MODIFICAR)
- `src/hooks/useAgenda.ts` - Ativar hooks reais (MODIFICAR)
- `src/services/agendaService.ts` - Completar implementa√ß√£o (MODIFICAR)
- `src/components/agenda/ConflictValidator.tsx` - Valida√ß√£o de conflitos (CRIAR)
- `src/utils/slotGenerator.ts` - Gerador de slots autom√°tico (CRIAR)

### **ü§ñ MCPs e Agents a Utilizar**
- **Supabase Integration MCP**: Para conectar aos dados reais
- **backend-architect**: Para validar integra√ß√£o dos servi√ßos
- **frontend-developer**: Para conectar UI aos hooks
- **api-tester**: Para testar fluxos de CRUD

### **‚úÖ Crit√©rios de Aceite**
- Appointments carregados do Supabase em tempo real
- CRUD de appointments funcionando completamente
- Sistema de slots gerando disponibilidade autom√°tica
- Valida√ß√£o de conflitos impedindo agendamentos inv√°lidos
- Zero console.log() em a√ß√µes de produ√ß√£o

### **‚ö†Ô∏è Riscos e Mitiga√ß√µes**
- **Risco**: Hooks existentes n√£o funcionarem como esperado
- **Mitiga√ß√£o**: Testar cada hook individualmente antes da integra√ß√£o
- **Risco**: Conflitos complexos n√£o detectados
- **Mitiga√ß√£o**: Implementar valida√ß√£o em m√∫ltiplas camadas (frontend + backend)

### **üîó Depend√™ncias**
- Supabase configurado com tabelas Appointment, AgentSchedule, AvailabilitySlot
- Sistema de autentica√ß√£o funcionando (userId real)
- RLS policies implementadas para agenda

---

## ‚öôÔ∏è **ETAPA 2: FUNCIONALIDADES PRINCIPAIS**
**Dura√ß√£o:** 2-3 dias | **Prioridade:** üü° ALTA

### **üéØ Contexto**
V√°rias funcionalidades est√£o implementadas mas ocultas ou n√£o funcionais. Precisa tornar vis√≠veis as tabs ocultas, implementar o booking wizard completo e sistema de notifica√ß√µes.

### **üìã Objetivos Espec√≠ficos**
- [ ] Tornar vis√≠veis tabs ocultas (AgentAvailability, NotificationSystem, etc.)
- [ ] Implementar booking wizard funcional completo
- [ ] Sistema de notifica√ß√µes real-time
- [ ] Configura√ß√£o de disponibilidade de agentes
- [ ] Status de sincroniza√ß√£o funcionais

### **üóÇÔ∏è Tarefas Detalhadas**

#### **Task 2.1: Tabs Ocultas - Investigar e Corrigir**
```typescript
// src/pages/Agenda.tsx - Investigar por que tabs est√£o hidden
// Remover hidden={true} ou implementar l√≥gica de visibilidade:
<TabsContent value="availability" className="hidden"> // REMOVER HIDDEN
<TabsContent value="notifications" className="hidden"> // REMOVER HIDDEN
<TabsContent value="sync" className="hidden"> // REMOVER HIDDEN
```

#### **Task 2.2: Booking Wizard Funcional**
```typescript
// src/components/agenda/BookingWizard.tsx
- Step 1: Sele√ß√£o de tipo de agendamento (IMPLEMENTAR)
- Step 2: Sele√ß√£o de data e hor√°rio dispon√≠vel (IMPLEMENTAR)
- Step 3: Sele√ß√£o de agente dispon√≠vel (IMPLEMENTAR)
- Step 4: Confirma√ß√£o e cria√ß√£o (IMPLEMENTAR)
- Integrar com slots de disponibilidade reais
```

#### **Task 2.3: Sistema de Notifica√ß√µes**
```typescript
// src/components/agenda/NotificationSystem.tsx
- Notifica√ß√µes de agendamentos criados
- Lembretes autom√°ticos (24h, 1h antes)
- Notifica√ß√µes de cancelamentos
- Status de confirma√ß√£o de clientes
```

#### **Task 2.4: Configura√ß√£o de Disponibilidade**
```typescript
// src/components/agenda/AgentAvailability.tsx
- Interface para configurar hor√°rios de trabalho
- Bloqueio de hor√°rios espec√≠ficos
- Configura√ß√£o de buffer time
- Limite de agendamentos por dia
```

### **üìÅ Arquivos a Criar/Modificar**
- `src/pages/Agenda.tsx` - Tornar tabs vis√≠veis (MODIFICAR)
- `src/components/agenda/BookingWizard.tsx` - Implementar passos (MODIFICAR)
- `src/components/agenda/NotificationSystem.tsx` - Sistema real (CRIAR)
- `src/components/agenda/AgentAvailability.tsx` - Interface completa (MODIFICAR)
- `src/hooks/useNotifications.ts` - Hook de notifica√ß√µes (CRIAR)

### **ü§ñ MCPs e Agents a Utilizar**
- **frontend-developer**: Para componentes de UI complexos
- **ui-designer**: Para melhor UX do booking wizard
- **backend-architect**: Para sistema de notifica√ß√µes

### **‚úÖ Crit√©rios de Aceite**
- Todas as tabs principais vis√≠veis e funcionais
- Booking wizard completo com 4 passos funcionais
- Notifica√ß√µes enviadas automaticamente
- Configura√ß√£o de disponibilidade salva e aplicada
- UI consistente e intuitiva

---

## üîó **ETAPA 3: INTEGRA√á√ïES AVAN√áADAS**
**Dura√ß√£o:** 1-2 dias | **Prioridade:** üü† M√âDIA

### **üéØ Contexto**
Completar integra√ß√µes com Google Calendar (60% pronta) e configurar N8N dashboard (20% pronto) para automa√ß√µes avan√ßadas.

### **üìã Objetivos Espec√≠ficos**
- [ ] Completar sincroniza√ß√£o bidirecional Google Calendar
- [ ] Configurar N8N backend e workflows
- [ ] Sistema de webhooks funcionais
- [ ] Automa√ß√µes de lembretes e follow-ups
- [ ] Logs de sincroniza√ß√£o detalhados

### **üóÇÔ∏è Tarefas Detalhadas**

#### **Task 3.1: Google Calendar Sincroniza√ß√£o Completa**
```typescript
// src/services/googleCalendarService.ts
- Sincroniza√ß√£o bidirecional (ImobiPRO ‚Üî Google)
- Webhooks para push notifications
- Atualiza√ß√£o autom√°tica de eventos
- Tratamento de conflitos entre sistemas
```

#### **Task 3.2: N8N Backend Configuration**
```typescript
// Configurar workflows N8N:
- Webhook para novos agendamentos
- Automa√ß√£o de lembretes via WhatsApp/Email
- Integra√ß√£o com Google Calendar via N8N
- Dashboard de monitoramento funcionais
```

#### **Task 3.3: Sistema de Webhooks**
```typescript
// src/services/webhookService.ts
- Receber webhooks do Google Calendar
- Processar updates de eventos
- Sincronizar mudan√ßas automaticamente
- Log de todas as opera√ß√µes
```

#### **Task 3.4: Logs e Monitoramento**
```typescript
// src/components/agenda/SyncStatus.tsx
- Status em tempo real de sincroniza√ß√µes
- Hist√≥rico de opera√ß√µes
- Alertas de falhas
- M√©tricas de performance
```

### **üìÅ Arquivos a Criar/Modificar**
- `src/services/googleCalendarService.ts` - Sincroniza√ß√£o completa (MODIFICAR)
- `src/services/webhookService.ts` - Sistema de webhooks (CRIAR)
- `src/components/agenda/N8nDashboard.tsx` - Backend real (MODIFICAR)
- `src/components/agenda/SyncStatus.tsx` - Logs detalhados (MODIFICAR)
- `src/hooks/useGoogleCalendar.ts` - Hooks completos (MODIFICAR)

### **ü§ñ MCPs e Agents a Utilizar**
- **Context7**: Para documenta√ß√£o Google Calendar API
- **api-tester**: Para testar webhooks e integra√ß√µes
- **backend-architect**: Para arquitetura de sincroniza√ß√£o

### **‚úÖ Crit√©rios de Aceite**
- Sincroniza√ß√£o bidirecional Google Calendar funcionando
- N8N workflows executando automa√ß√µes
- Webhooks recebendo e processando eventos
- Dashboard de monitoramento com m√©tricas reais
- Logs detalhados de todas as opera√ß√µes

---

## üß™ **ETAPA 4: TESTES E VALIDA√á√ÉO**
**Dura√ß√£o:** 1-2 dias | **Prioridade:** üü¢ IMPORTANTE

### **üéØ Contexto**
Implementar cobertura completa de testes (atualmente 0%) para garantir qualidade e confiabilidade do sistema de agenda, incluindo cen√°rios complexos de sincroniza√ß√£o e conflitos.

### **üìã Objetivos Espec√≠ficos**
- [ ] Testes unit√°rios para todos os componentes
- [ ] Testes de integra√ß√£o com Supabase e Google Calendar
- [ ] Testes de valida√ß√£o de conflitos
- [ ] Testes de automa√ß√µes N8N
- [ ] Testes de performance com m√∫ltiplos agendamentos

### **üóÇÔ∏è Tarefas Detalhadas**

#### **Task 4.1: Testes Unit√°rios Core**
```typescript
// src/tests/agenda/
- BookingWizard.test.tsx - Fluxo de agendamento completo
- AgentAvailability.test.tsx - Configura√ß√£o de disponibilidade
- ConflictValidator.test.tsx - Valida√ß√£o de conflitos
- SlotGenerator.test.tsx - Gera√ß√£o de slots
```

#### **Task 4.2: Testes de Integra√ß√£o**
```typescript
// src/tests/integration/agenda/
- GoogleCalendarSync.integration.test.tsx
- SupabaseAppointments.integration.test.tsx  
- N8nWebhooks.integration.test.tsx
- ConflictDetection.integration.test.tsx
```

#### **Task 4.3: Testes de Cen√°rios Complexos**
```typescript
// Cen√°rios espec√≠ficos da agenda:
- M√∫ltiplos agendamentos simult√¢neos
- Sincroniza√ß√£o durante conflitos
- Falhas de rede durante opera√ß√µes
- Recupera√ß√£o de dados offline
```

#### **Task 4.4: Testes de Performance**
```typescript
// Validar performance com:
- 100+ agendamentos por agente
- Sincroniza√ß√£o de calend√°rios grandes
- Gera√ß√£o de slots para m√∫ltiplos agentes
- Webhooks em alta frequ√™ncia
```

### **üìÅ Arquivos a Criar/Modificar**
- `src/tests/agenda/BookingWizard.test.tsx` (CRIAR)
- `src/tests/agenda/AgentAvailability.test.tsx` (CRIAR)
- `src/tests/integration/agenda/GoogleCalendarSync.test.tsx` (CRIAR)
- `src/tests/integration/agenda/ConflictDetection.test.tsx` (CRIAR)
- `src/tests/utils/agendaTestHelpers.ts` - Helpers de testes (CRIAR)

### **ü§ñ MCPs e Agents a Utilizar**
- **test-writer-fixer**: Para cria√ß√£o e manuten√ß√£o dos testes
- **api-tester**: Para testes de integra√ß√£o externa
- **performance-benchmarker**: Para testes de performance

### **‚úÖ Crit√©rios de Aceite**
- Cobertura de testes > 80%
- Todos os cen√°rios cr√≠ticos testados
- Testes de integra√ß√£o com Google Calendar passando
- Valida√ß√£o de conflitos funcionando em todos os casos
- Performance adequada com alta carga de dados

---

## üìä **M√âTRICAS DE SUCESSO**

| M√©trica | Estado Atual | Meta | Como Medir |
|---------|-------------|------|------------|
| **Integra√ß√£o Real** | 30% | 100% | Dados do Supabase |
| **Funcionalidades** | 40% | 100% | Todas funcions operacionais |
| **Google Calendar** | 60% | 100% | Sincroniza√ß√£o bidirecional |
| **N8N Integration** | 20% | 100% | Automa√ß√µes funcionando |
| **Testes** | 0% | 80% | Coverage report |
| **Performance** | N/A | < 3s | Lighthouse + carga |

---

## üéØ **RECURSOS NECESS√ÅRIOS**

### **MCPs Principais**
- **Sequential Thinking**: Estrutura√ß√£o de tarefas complexas de integra√ß√£o
- **Supabase Integration**: Opera√ß√µes de banco e RLS
- **Context7**: Documenta√ß√£o Google Calendar API, date-fns, N8N
- **Semgrep Security**: Valida√ß√£o de c√≥digo das integra√ß√µes

### **Agents Especializados**
- **backend-architect**: APIs, integra√ß√µes e sincroniza√ß√£o
- **frontend-developer**: Conectar UI aos dados reais  
- **api-tester**: Testes de integra√ß√µes externas (Google, N8N)
- **ui-designer**: UX do booking wizard e disponibilidade
- **test-writer-fixer**: Testes automatizados completos

---

## üîÑ **PR√ìXIMOS PASSOS**

1. **Investigar tabs ocultas** - Entender por que est√£o hidden
2. **Testar hooks existentes** - Validar funcionamento dos servi√ßos
3. **Configurar ambiente N8N** - Setup de workflows
4. **Preparar dados de teste** - Agendamentos, slots, conflitos
5. **Validar Google Calendar OAuth** - Confirmar tokens funcionais

---

## üìù **Observa√ß√µes Finais**

O **M√≥dulo Agenda** tem vantagem significativa sobre outros m√≥dulos: j√° possui infraestrutura robusta (70% backend, 80% UI). O trabalho ser√° principalmente de **integra√ß√£o e ativa√ß√£o** das funcionalidades existentes.

**Diferencial T√©cnico:**
- Sistema de slots sofisticado j√° implementado
- OAuth Google Calendar funcional  
- Schema de banco bem estruturado
- Hooks e servi√ßos organizados

**Tempo Total Estimado:** 6-10 dias  
**Risco:** Baixo-M√©dio (infraestrutura j√° existe)  
**Impacto:** Alto (sistema cr√≠tico para opera√ß√£o)  
**Complexidade:** M√©dia (foco em integra√ß√£o)

---

**Documento criado por:** Claude Code com Sequential Thinking MCP  
**Pr√≥xima atualiza√ß√£o:** Ap√≥s conclus√£o da Etapa 1  
**Status:** üìã Pronto para implementa√ß√£o